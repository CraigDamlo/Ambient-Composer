<!DOCTYPE html>
<!-- saved from url=(0060)file:///Users/Craig/Downloads/ambient-chord-generator_1.html -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ambient Chord Generator</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #1e1b4b 0%, #581c87 50%, #0f172a 100%);
            min-height: 100vh;
            padding: 2rem;
            color: #e9d5ff;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .card {
            background: rgba(30, 27, 75, 0.6);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 1.5rem;
            border: 1px solid rgba(168, 85, 247, 0.3);
        }
        h1 { font-size: 2rem; font-weight: bold; margin-bottom: 0.5rem; }
        button {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            margin-right: 0.5rem;
        }
        .btn-primary { background: #9333ea; color: white; }
        .btn-secondary { background: #16a34a; color: white; }
        .btn-midi { background: #0369a1; color: white; }
        .controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin: 1.5rem 0; }
        .control-group { display: flex; flex-direction: column; }
        label { font-size: 0.875rem; margin-bottom: 0.5rem; }
        select, input[type="range"] { 
            padding: 0.5rem; 
            background: #334155; 
            color: #e9d5ff; 
            border: 1px solid rgba(168, 85, 247, 0.3); 
            border-radius: 8px; 
        }
        .chord-item {
            padding: 1rem;
            background: rgba(51, 65, 85, 0.5);
            border: 1px solid rgba(168, 85, 247, 0.2);
            border-radius: 8px;
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
        }
        .chord-name { font-size: 1.5rem; font-weight: bold; }
        .timeline-wrapper { 
            background: rgba(15, 23, 42, 0.8); 
            border-radius: 8px; 
            padding: 1.5rem; 
            padding-left: 70px;
        }
        #timeline { 
            position: relative; 
            width: 100%;
        }
        .note-labels {
            position: absolute;
            left: -58px;
            top: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .grid-line {
            position: absolute;
            left: 0;
            right: 0;
            height: 1px;
            background: rgba(168, 85, 247, 0.15);
        }
        #canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; cursor: crosshair; }
        #timeline-tooltip {
            position: fixed;
            pointer-events: none;
            background: rgba(15, 10, 40, 0.92);
            border: 1px solid rgba(168, 85, 247, 0.5);
            border-radius: 8px;
            padding: 0.5rem 0.75rem;
            font-family: monospace;
            font-size: 0.8rem;
            color: #e9d5ff;
            line-height: 1.6;
            white-space: nowrap;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            opacity: 0;
            transition: opacity 0.1s ease;
            z-index: 100;
        }
        #timeline-tooltip.visible { opacity: 1; }

        /* Bass line styles */
        .bass-note-item {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            padding: 0.6rem 0.8rem;
            background: rgba(30, 64, 115, 0.5);
            border: 1px solid rgba(56, 189, 248, 0.3);
            border-radius: 8px;
            margin: 0.25rem;
            font-family: monospace;
            min-width: 60px;
        }
        .bass-note-name { font-size: 1.1rem; font-weight: bold; color: #7dd3fc; }
        .bass-note-dur { font-size: 0.75rem; color: rgba(125, 211, 252, 0.6); margin-top: 2px; }
        .bass-note-type { font-size: 0.7rem; color: rgba(125, 211, 252, 0.45); }
        #bassNoteContainer { display: flex; flex-wrap: wrap; margin-top: 0.75rem; }
        .section-divider {
            height: 1px;
            background: rgba(168, 85, 247, 0.2);
            margin: 1.5rem 0;
        }
    </style>
</head>
<body>
    <div id="timeline-tooltip"></div>
    <div class="container">
        <div class="card">
            <h1>Ambient Chord Progression Generator</h1>
            <p style="color: rgba(233, 213, 255, 0.7); margin-bottom: 1.5rem;">
                Generate evolving chord progressions for your hardware synths
            </p>
            
            <div>
                <button class="btn-primary" onclick="generateProgression()">â†» Generate New</button>
                <button class="btn-secondary" onclick="exportProgression()">ðŸ“‹ Copy to Clipboard</button>
                <button class="btn-midi" onclick="exportMidi()">â¬‡ Download MIDI</button>
            </div>

            <div style="display:flex; align-items:center; gap:1rem; margin-top:1rem;">
                <div class="control-group" style="flex-direction:row; align-items:center; gap:0.75rem; margin:0;">
                    <label style="margin:0; white-space:nowrap;">BPM: <span id="bpmVal">60</span></label>
                    <input type="range" id="bpm" min="20" max="120" value="60" style="width:140px;" oninput="document.getElementById(&#39;bpmVal&#39;).textContent=this.value">
                </div>
            </div>

            <div class="controls">
                <div class="control-group">
                    <label>Key</label>
                    <select id="key" onchange="generateProgression()">
                        <option>C</option><option>C#</option><option>D</option><option>D#</option>
                        <option>E</option><option>F</option><option>F#</option><option>G</option>
                        <option>G#</option><option>A</option><option>A#</option><option>B</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Mode</label>
                    <select id="mode" onchange="generateProgression()">
                        <option value="major">Major</option>
                        <option value="minor">Minor</option>
                        <option value="dorian">Dorian</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Voicing Mode</label>
                    <select id="voicingMode" onchange="updateVoicingControls(); generateProgression()">
                        <option value="fixed">Fixed</option>
                        <option value="varied">Varied</option>
                        <option value="random">Random</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Length: <span id="lengthVal">4</span></label>
                    <input type="range" id="length" min="2" max="8" value="4" oninput="document.getElementById(&#39;lengthVal&#39;).textContent=this.value; generateProgression()">
                </div>
                <div class="control-group">
                    <label>Change Rate: <span id="rateVal">4</span> beats</label>
                    <input type="range" id="rate" min="2" max="16" step="2" value="4" oninput="document.getElementById(&#39;rateVal&#39;).textContent=this.value; generateProgression()">
                </div>
            </div>

            <div id="voicingFixed" class="control-group" style="margin-bottom: 1rem; display: block;">
                <label>Fixed Voicing Type</label>
                <select id="fixedVoicing" onchange="generateProgression()">
                    <option value="triad">Triad (3 notes)</option>
                    <option value="seventh" selected="">7th (4 notes)</option>
                    <option value="ninth">9th (5 notes)</option>
                    <option value="eleventh">11th (6 notes)</option>
                </select>
            </div>

            <div id="voicingVaried" class="control-group" style="margin-bottom: 1rem; display: none;">
                <label>Voicing Complexity: <span id="varietyVal">50</span>%</label>
                <input type="range" id="variety" min="0" max="1" step="0.1" value="0.5" oninput="document.getElementById(&#39;varietyVal&#39;).textContent=Math.round(this.value*100); generateProgression()">
            </div>

            <div class="control-group" style="margin-bottom: 1rem;">
                <label>Timing Complexity: <span id="complexityVal">30</span>%</label>
                <input type="range" id="complexity" min="0" max="1" step="0.1" value="0.3" oninput="document.getElementById(&#39;complexityVal&#39;).textContent=Math.round(this.value*100); generateProgression()">
            </div>

            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <input type="checkbox" id="inversions" checked="" onchange="generateProgression()">
                <label for="inversions">Smart Inversions (smooth voice leading and loops)</label>
            </div>
        </div>

        <div class="card">
            <h2 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem;">Current Progression</h2>
            <div id="loopQuality" style="margin-bottom: 1rem; padding: 1rem; background: rgba(34, 197, 94, 0.2); border-radius: 8px;"><strong>Loop Quality: Excellent âœ“</strong><br>Average distance: 1.0 semitones (very smooth loop)<br><span style="font-size: 0.875rem; color: rgba(233, 213, 255, 0.7);">Voice 1: 2 semitones â€¢ Voice 2: 0 semitones â€¢ Voice 3: 0 semitones â€¢ Voice 4: 2 semitones</span></div>
            <div id="progressionList">
                <div class="chord-item">
                    <div>
                        <span class="chord-name">I</span>
                        <span style="color: #d8b4fe; margin-left: 1rem;">B3 - C4 - E4 - G4</span>
                        <span style="color: rgba(233,213,255,0.6); font-size: 0.875rem; margin-left: 0.75rem;">
                            (seventh, 3rd inv)
                        </span>
                    </div>
                    <div style="font-family: monospace; color: #d8b4fe;">2 beats</div>
                </div>
            
                <div class="chord-item">
                    <div>
                        <span class="chord-name">V</span>
                        <span style="color: #d8b4fe; margin-left: 1rem;">B3 - D4 - F4 - G4</span>
                        <span style="color: rgba(233,213,255,0.6); font-size: 0.875rem; margin-left: 0.75rem;">
                            (seventh, 1st inv)
                        </span>
                    </div>
                    <div style="font-family: monospace; color: #d8b4fe;">4 beats</div>
                </div>
            
                <div class="chord-item">
                    <div>
                        <span class="chord-name">vi</span>
                        <span style="color: #d8b4fe; margin-left: 1rem;">A3 - C4 - E4 - G4</span>
                        <span style="color: rgba(233,213,255,0.6); font-size: 0.875rem; margin-left: 0.75rem;">
                            (seventh, root inv)
                        </span>
                    </div>
                    <div style="font-family: monospace; color: #d8b4fe;">4 beats</div>
                </div>
            
                <div class="chord-item">
                    <div>
                        <span class="chord-name">IV</span>
                        <span style="color: #d8b4fe; margin-left: 1rem;">A3 - C4 - E4 - F4</span>
                        <span style="color: rgba(233,213,255,0.6); font-size: 0.875rem; margin-left: 0.75rem;">
                            (seventh, 1st inv)
                        </span>
                    </div>
                    <div style="font-family: monospace; color: #d8b4fe;">4 beats</div>
                </div>
            </div>
        </div>

        <!-- BASS LINE CARD -->
        <div class="card">
            <h2 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 0.25rem;">Bass Line</h2>
            <p style="color: rgba(125, 211, 252, 0.7); font-size: 0.875rem; margin-bottom: 1.25rem;">
                Auto-generated bass following the chord progression
            </p>

            <div class="controls">
                <div class="control-group">
                    <label>Bass Style</label>
                    <select id="bassStyle" onchange="generateBassLine()">
                        <option value="root">Root Only</option>
                        <option value="rootFifth">Root + Fifth</option>
                        <option value="walking">Walking</option>
                        <option value="arpeggiated">Arpeggiated</option>
                        <option value="pedal">Pedal Point</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Bass Octave</label>
                    <select id="bassOctave" onchange="generateBassLine()">
                        <option value="1">Octave 1 (very deep)</option>
                        <option value="2" selected="">Octave 2 (deep)</option>
                        <option value="3">Octave 3 (mid-bass)</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Bass Density: <span id="densityVal">50</span>%</label>
                    <input type="range" id="bassDensity" min="0" max="1" step="0.1" value="0.5" oninput="document.getElementById(&#39;densityVal&#39;).textContent=Math.round(this.value*100); generateBassLine()">
                </div>
                <div class="control-group">
                    <label>Syncopation: <span id="syncoVal">20</span>%</label>
                    <input type="range" id="bassSynco" min="0" max="1" step="0.1" value="0.2" oninput="document.getElementById(&#39;syncoVal&#39;).textContent=Math.round(this.value*100); generateBassLine()">
                </div>
            </div>

            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                <input type="checkbox" id="bassRests" onchange="generateBassLine()">
                <label for="bassRests">Include rests</label>
                &nbsp;&nbsp;
                <input type="checkbox" id="bassOctaveJumps" onchange="generateBassLine()">
                <label for="bassOctaveJumps">Octave jumps</label>
            </div>

            <div id="bassNoteContainer">
                <div class="bass-note-item" style="">
                    <span class="bass-note-name">C2</span>
                    <span class="bass-note-dur">2b</span>
                    <span class="bass-note-type">root</span>
                </div>
            
                <div class="bass-note-item" style="">
                    <span class="bass-note-name">G2</span>
                    <span class="bass-note-dur">4b</span>
                    <span class="bass-note-type">root</span>
                </div>
            
                <div class="bass-note-item" style="">
                    <span class="bass-note-name">A2</span>
                    <span class="bass-note-dur">4b</span>
                    <span class="bass-note-type">root</span>
                </div>
            
                <div class="bass-note-item" style="">
                    <span class="bass-note-name">F2</span>
                    <span class="bass-note-dur">4b</span>
                    <span class="bass-note-type">root</span>
                </div>
            </div>

            <div class="section-divider"></div>

            <div id="bassTimeline" style="background: rgba(15, 23, 42, 0.8); border-radius: 8px; padding: 1.5rem; padding-left: 70px;">
                <div id="bassTimelineInner" style="position: relative; width: 100%; height: 120px;">
                    <canvas id="bassCanvas" style="position:absolute;top:0;left:0;width:100%;height:100%;" width="1040" height="120"></canvas>
                </div>
            </div>
        </div>

        <div class="card">
            <h2 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 0.5rem;">Timeline View</h2>
            <div style="display:flex; gap:1.5rem; margin-bottom:1rem; font-size:0.8rem; color:rgba(233,213,255,0.6);">
                <span><span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:#8b5cf6;margin-right:5px;vertical-align:middle;"></span>Chords</span>
                <span><span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:#38bdf8;margin-right:5px;vertical-align:middle;"></span>Bass</span>
            </div>
            <div class="timeline-wrapper">
                <div id="timeline" style="height: 476px;">
                    <canvas id="canvas" width="1040" height="476"></canvas>
                <div class="note-labels"><div style="color: rgb(216, 180, 254); font-size: 8px; font-family: monospace; line-height: 14px;">G#4</div><div style="color: rgb(216, 180, 254); font-size: 8px; font-family: monospace; line-height: 14px;">G4</div><div style="color: rgb(216, 180, 254); font-size: 8px; font-family: monospace; line-height: 14px;">F#4</div><div style="color: rgb(216, 180, 254); font-size: 8px; font-family: monospace; line-height: 14px;">F4</div><div style="color: rgb(216, 180, 254); font-size: 8px; font-family: monospace; line-height: 14px;">E4</div><div style="color: rgb(216, 180, 254); font-size: 8px; font-family: monospace; line-height: 14px;">D#4</div><div style="color: rgb(216, 180, 254); font-size: 8px; font-family: monospace; line-height: 14px;">D4</div><div style="color: rgb(216, 180, 254); font-size: 8px; font-family: monospace; line-height: 14px;">C#4</div><div style="color: rgb(216, 180, 254); font-size: 8px; font-family: monospace; line-height: 14px;">C4</div><div style="color: rgb(216, 180, 254); font-size: 8px; font-family: monospace; line-height: 14px;">B3</div><div style="color: rgb(216, 180, 254); font-size: 8px; font-family: monospace; line-height: 14px;">A#3</div><div style="color: rgb(216, 180, 254); font-size: 8px; font-family: monospace; line-height: 14px;">A3</div><div style="color: rgb(216, 180, 254); font-size: 8px; font-family: monospace; line-height: 14px;">G#3</div><div style="color: rgb(216, 180, 254); font-size: 8px; font-family: monospace; line-height: 14px;">G3</div><div style="color: rgb(216, 180, 254); font-size: 8px; font-family: monospace; line-height: 14px;">F#3</div><div style="color: rgb(216, 180, 254); font-size: 8px; font-family: monospace; line-height: 14px;">F3</div><div style="color: rgb(216, 180, 254); font-size: 8px; font-family: monospace; line-height: 14px;">E3</div><div style="color: rgb(216, 180, 254); font-size: 8px; font-family: monospace; line-height: 14px;">D#3</div><div style="color: rgb(216, 180, 254); font-size: 8px; font-family: monospace; line-height: 14px;">D3</div><div style="color: rgb(216, 180, 254); font-size: 8px; font-family: monospace; line-height: 14px;">C#3</div><div style="color: rgb(216, 180, 254); font-size: 8px; font-family: monospace; line-height: 14px;">C3</div><div style="color: rgb(216, 180, 254); font-size: 8px; font-family: monospace; line-height: 14px;">B2</div><div style="color: rgb(216, 180, 254); font-size: 8px; font-family: monospace; line-height: 14px;">A#2</div><div style="color: rgb(125, 211, 252); font-size: 8px; font-family: monospace; line-height: 14px;">A2</div><div style="color: rgb(216, 180, 254); font-size: 8px; font-family: monospace; line-height: 14px;">G#2</div><div style="color: rgb(125, 211, 252); font-size: 8px; font-family: monospace; line-height: 14px;">G2</div><div style="color: rgb(216, 180, 254); font-size: 8px; font-family: monospace; line-height: 14px;">F#2</div><div style="color: rgb(125, 211, 252); font-size: 8px; font-family: monospace; line-height: 14px;">F2</div><div style="color: rgb(216, 180, 254); font-size: 8px; font-family: monospace; line-height: 14px;">E2</div><div style="color: rgb(216, 180, 254); font-size: 8px; font-family: monospace; line-height: 14px;">D#2</div><div style="color: rgb(216, 180, 254); font-size: 8px; font-family: monospace; line-height: 14px;">D2</div><div style="color: rgb(216, 180, 254); font-size: 8px; font-family: monospace; line-height: 14px;">C#2</div><div style="color: rgb(125, 211, 252); font-size: 8px; font-family: monospace; line-height: 14px;">C2</div><div style="color: rgb(216, 180, 254); font-size: 8px; font-family: monospace; line-height: 14px;">B1</div></div><div class="grid-line" style="top: 0px;"></div><div class="grid-line" style="top: 14.4242px;"></div><div class="grid-line" style="top: 28.8485px;"></div><div class="grid-line" style="top: 43.2727px;"></div><div class="grid-line" style="top: 57.697px;"></div><div class="grid-line" style="top: 72.1212px;"></div><div class="grid-line" style="top: 86.5455px;"></div><div class="grid-line" style="top: 100.97px;"></div><div class="grid-line" style="top: 115.394px;"></div><div class="grid-line" style="top: 129.818px;"></div><div class="grid-line" style="top: 144.242px;"></div><div class="grid-line" style="top: 158.667px;"></div><div class="grid-line" style="top: 173.091px;"></div><div class="grid-line" style="top: 187.515px;"></div><div class="grid-line" style="top: 201.939px;"></div><div class="grid-line" style="top: 216.364px;"></div><div class="grid-line" style="top: 230.788px;"></div><div class="grid-line" style="top: 245.212px;"></div><div class="grid-line" style="top: 259.636px;"></div><div class="grid-line" style="top: 274.061px;"></div><div class="grid-line" style="top: 288.485px;"></div><div class="grid-line" style="top: 302.909px;"></div><div class="grid-line" style="top: 317.333px;"></div><div class="grid-line" style="top: 331.758px;"></div><div class="grid-line" style="top: 346.182px;"></div><div class="grid-line" style="top: 360.606px;"></div><div class="grid-line" style="top: 375.03px;"></div><div class="grid-line" style="top: 389.455px;"></div><div class="grid-line" style="top: 403.879px;"></div><div class="grid-line" style="top: 418.303px;"></div><div class="grid-line" style="top: 432.727px;"></div><div class="grid-line" style="top: 447.152px;"></div><div class="grid-line" style="top: 461.576px;"></div><div class="grid-line" style="top: 476px;"></div></div>
            </div>
        </div>
    </div>

    <script>
        let progression = [];
        let bassLine = [];
        let timelineHitTargets = []; // { x, y, label, isBass }
        
        const chordLibrary = {
            major: {
                I: { triad: [0,4,7], seventh: [0,4,7,11], ninth: [0,4,7,11,14], eleventh: [0,4,7,11,14,17] },
                ii: { triad: [2,5,9], seventh: [2,5,9,12], ninth: [2,5,9,12,16], eleventh: [2,5,9,12,16,19] },
                iii: { triad: [4,7,11], seventh: [4,7,11,14], ninth: [4,7,11,14,16], eleventh: [4,7,11,14,16,19] },
                IV: { triad: [5,9,12], seventh: [5,9,12,16], ninth: [5,9,12,16,19], eleventh: [5,9,12,16,19,22] },
                V: { triad: [7,11,14], seventh: [7,11,14,17], ninth: [7,11,14,17,21], eleventh: [7,11,14,17,21,24] },
                vi: { triad: [9,12,16], seventh: [9,12,16,19], ninth: [9,12,16,19,21], eleventh: [9,12,16,19,21,24] },
                'viiÂ°': { triad: [11,14,17], seventh: [11,14,17,20], ninth: [11,14,17,20,23], eleventh: [11,14,17,20,23,26] }
            },
            minor: {
                i: { triad: [0,3,7], seventh: [0,3,7,10], ninth: [0,3,7,10,14], eleventh: [0,3,7,10,14,17] },
                'iiÂ°': { triad: [2,5,8], seventh: [2,5,8,12], ninth: [2,5,8,12,15], eleventh: [2,5,8,12,15,19] },
                III: { triad: [3,7,10], seventh: [3,7,10,14], ninth: [3,7,10,14,17], eleventh: [3,7,10,14,17,20] },
                iv: { triad: [5,8,12], seventh: [5,8,12,15], ninth: [5,8,12,15,19], eleventh: [5,8,12,15,19,22] },
                v: { triad: [7,10,14], seventh: [7,10,14,17], ninth: [7,10,14,17,19], eleventh: [7,10,14,17,19,22] },
                VI: { triad: [8,12,15], seventh: [8,12,15,19], ninth: [8,12,15,19,22], eleventh: [8,12,15,19,22,24] },
                VII: { triad: [10,14,17], seventh: [10,14,17,20], ninth: [10,14,17,20,22], eleventh: [10,14,17,20,22,24] }
            },
            dorian: {
                i: { triad: [0,3,7], seventh: [0,3,7,10], ninth: [0,3,7,10,14], eleventh: [0,3,7,10,14,17] },
                ii: { triad: [2,5,9], seventh: [2,5,9,12], ninth: [2,5,9,12,16], eleventh: [2,5,9,12,16,19] },
                III: { triad: [3,7,10], seventh: [3,7,10,14], ninth: [3,7,10,14,17], eleventh: [3,7,10,14,17,19] },
                IV: { triad: [5,9,12], seventh: [5,9,12,16], ninth: [5,9,12,16,19], eleventh: [5,9,12,16,19,21] },
                v: { triad: [7,10,14], seventh: [7,10,14,17], ninth: [7,10,14,17,19], eleventh: [7,10,14,17,19,21] },
                'viÂ°': { triad: [9,12,15], seventh: [9,12,15,19], ninth: [9,12,15,19,21], eleventh: [9,12,15,19,21,24] },
                VII: { triad: [10,14,17], seventh: [10,14,17,21], ninth: [10,14,17,21,24], eleventh: [10,14,17,21,24,26] }
            }
        };

        const commonProgressions = {
            major: [['I','V','vi','IV'], ['I','vi','IV','V'], ['I','IV','V','IV'], ['vi','IV','I','V']],
            minor: [['i','VI','III','VII'], ['i','iv','VII','VI'], ['i','VI','VII','i']],
            dorian: [['i','IV','i','IV'], ['i','ii','IV','i'], ['i','VII','IV','i']]
        };

        function noteToMidi(note, octave = 3) {
            const map = {'C':0,'C#':1,'D':2,'D#':3,'E':4,'F':5,'F#':6,'G':7,'G#':8,'A':9,'A#':10,'B':11};
            return map[note] + (octave + 1) * 12;
        }

        function midiToNote(midi) {
            const notes = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
            return notes[midi % 12] + (Math.floor(midi / 12) - 1);
        }

        function noteNameToMidi(name) {
            const match = name.match(/([A-G]#?)(\d+)/);
            if (!match) return 60;
            const map = {'C':0,'C#':1,'D':2,'D#':3,'E':4,'F':5,'F#':6,'G':7,'G#':8,'A':9,'A#':10,'B':11};
            return map[match[1]] + (parseInt(match[2]) + 1) * 12;
        }

        function findBestInversion(chord, prevChord) {
            if (!prevChord || prevChord.length === 0) return chord;
            const inversions = [];
            for (let i = 0; i < chord.length; i++) {
                const inv = [...chord];
                for (let j = 0; j < i; j++) inv.push(inv.shift() + 12);
                inversions.push(inv);
            }
            let best = inversions[0], minDist = Infinity;
            inversions.forEach(inv => {
                let dist = 0;
                const voices = Math.min(inv.length, prevChord.length);
                for (let i = 0; i < voices; i++) dist += Math.abs(inv[i] - prevChord[i]);
                if (dist < minDist) { minDist = dist; best = inv; }
            });
            return best;
        }

        function updateVoicingControls() {
            const mode = document.getElementById('voicingMode').value;
            document.getElementById('voicingFixed').style.display = mode === 'fixed' ? 'block' : 'none';
            document.getElementById('voicingVaried').style.display = mode === 'varied' ? 'block' : 'none';
        }

        // â”€â”€â”€ BASS LINE GENERATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        function getChordMidiNotes(chord, octave) {
            // chord.notes are strings like "C3", "E3"...
            // We re-map them to the requested bass octave
            return chord.notes.map(n => {
                const match = n.match(/([A-G]#?)(\d+)/);
                const map = {'C':0,'C#':1,'D':2,'D#':3,'E':4,'F':5,'F#':6,'G':7,'G#':8,'A':9,'A#':10,'B':11};
                return map[match[1]] + (parseInt(octave) + 1) * 12;
            });
        }

        function generateBassLine() {
            if (progression.length === 0) return;

            const style = document.getElementById('bassStyle').value;
            const octave = parseInt(document.getElementById('bassOctave').value);
            const density = parseFloat(document.getElementById('bassDensity').value);
            const synco = parseFloat(document.getElementById('bassSynco').value);
            const useRests = document.getElementById('bassRests').checked;
            const useOctaveJumps = document.getElementById('bassOctaveJumps').checked;

            bassLine = [];

            progression.forEach(chord => {
                const rootMidi = noteToMidi(document.getElementById('key').value, octave)
                    + chordLibrary[document.getElementById('mode').value][chord.name].triad[0];
                const fifthMidi = rootMidi + 7;
                const thirdMidi = rootMidi + (document.getElementById('mode').value === 'major' ? 4 : 3);
                const chordTones = [rootMidi, thirdMidi, fifthMidi];
                const duration = chord.duration;

                // Build a list of sub-notes within this chord's duration
                const notes = [];
                let beat = 0;

                if (style === 'root') {
                    // One note per chord, whole duration
                    notes.push({ midi: rootMidi, duration, type: 'root', rest: false });
                }
                else if (style === 'rootFifth') {
                    // Alternate root and fifth on half-durations
                    const half = Math.max(1, Math.floor(duration / 2));
                    notes.push({ midi: rootMidi, duration: half, type: 'root', rest: false });
                    notes.push({ midi: fifthMidi, duration: duration - half, type: '5th', rest: false });
                }
                else if (style === 'walking') {
                    // Walk down/up chord tones per beat
                    let remaining = duration;
                    let dir = Math.random() < 0.5 ? 1 : -1;
                    let pos = 0;
                    while (remaining > 0) {
                        const noteDur = Math.random() < synco ? 1 : 2;
                        const dur = Math.min(noteDur, remaining);
                        const isRest = useRests && Math.random() < (1 - density) * 0.4;
                        const midi = chordTones[((pos % chordTones.length) + chordTones.length) % chordTones.length];
                        const octJump = useOctaveJumps && Math.random() < 0.12;
                        notes.push({ midi: midi + (octJump ? 12 : 0), duration: dur, type: 'walk', rest: isRest });
                        pos += dir;
                        if (Math.random() < 0.3) dir *= -1;
                        remaining -= dur;
                    }
                }
                else if (style === 'arpeggiated') {
                    let remaining = duration;
                    let pos = 0;
                    while (remaining > 0) {
                        const noteDur = Math.random() < synco ? 1 : 2;
                        const dur = Math.min(noteDur, remaining);
                        const isRest = useRests && Math.random() < (1 - density) * 0.35;
                        const toneIdx = pos % chordTones.length;
                        const octShift = useOctaveJumps && pos >= chordTones.length ? 12 : 0;
                        notes.push({ midi: chordTones[toneIdx] + octShift, duration: dur, type: 'arp', rest: isRest });
                        pos++;
                        remaining -= dur;
                    }
                }
                else if (style === 'pedal') {
                    // Root on beat 1, rests/skips otherwise
                    let remaining = duration;
                    notes.push({ midi: rootMidi, duration: 2, type: 'pedal', rest: false });
                    remaining -= 2;
                    while (remaining > 0) {
                        const dur = Math.min(2, remaining);
                        const isRest = Math.random() < (1 - density * 0.7);
                        notes.push({ midi: rootMidi + (useOctaveJumps && !isRest && Math.random() < 0.3 ? 12 : 0), duration: dur, type: 'pedal', rest: isRest });
                        remaining -= dur;
                    }
                }

                bassLine.push(...notes);
            });

            displayBassLine();
            drawBassTimeline();
            drawTimeline(); // redraw combined view
        }

        function displayBassLine() {
            const container = document.getElementById('bassNoteContainer');
            container.innerHTML = bassLine.map(n => `
                <div class="bass-note-item" style="${n.rest ? 'opacity:0.4;' : ''}">
                    <span class="bass-note-name">${n.rest ? 'â€”' : midiToNote(n.midi)}</span>
                    <span class="bass-note-dur">${n.duration}b</span>
                    <span class="bass-note-type">${n.rest ? 'rest' : n.type}</span>
                </div>
            `).join('');
        }

        function drawBassTimeline() {
            const canvas = document.getElementById('bassCanvas');
            const ctx = canvas.getContext('2d');
            const container = document.getElementById('bassTimelineInner');
            const width = container.clientWidth || 800;
            const height = 120;
            canvas.width = width;
            canvas.height = height;
            ctx.clearRect(0, 0, width, height);

            if (bassLine.length === 0) return;

            const totalBeats = bassLine.reduce((s, n) => s + n.duration, 0);
            const activeMidi = bassLine.filter(n => !n.rest).map(n => n.midi);
            if (activeMidi.length === 0) return;

            const minNote = Math.min(...activeMidi) - 1;
            const maxNote = Math.max(...activeMidi) + 1;
            const noteRange = maxNote - minNote || 1;

            const padding = 10;
            let x = padding;

            bassLine.forEach((note, i) => {
                const w = (note.duration / totalBeats) * (width - padding * 2);

                if (!note.rest) {
                    const y = ((maxNote - note.midi) / noteRange) * (height - 20) + 10;
                    // Draw block
                    ctx.fillStyle = 'rgba(14, 165, 233, 0.15)';
                    ctx.fillRect(x + 1, y - 8, w - 2, 16);
                    // Draw line
                    ctx.strokeStyle = 'rgba(56, 189, 248, 0.8)';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.moveTo(x, y);
                    ctx.lineTo(x + w, y);
                    ctx.stroke();
                    // Dot
                    ctx.fillStyle = '#38bdf8';
                    ctx.beginPath();
                    ctx.arc(x + 4, y, 4, 0, Math.PI * 2);
                    ctx.fill();
                    // Label
                    ctx.fillStyle = 'rgba(125, 211, 252, 0.85)';
                    ctx.font = '10px monospace';
                    ctx.fillText(midiToNote(note.midi), x + 10, y + 4);
                } else {
                    // Rest - dashed line
                    ctx.strokeStyle = 'rgba(56, 189, 248, 0.2)';
                    ctx.lineWidth = 1;
                    ctx.setLineDash([3, 4]);
                    ctx.beginPath();
                    ctx.moveTo(x, height / 2);
                    ctx.lineTo(x + w, height / 2);
                    ctx.stroke();
                    ctx.setLineDash([]);
                }

                x += w;
            });

            // Connect non-rest notes with faint lines
            const notePositions = [];
            let cx = padding;
            bassLine.forEach(note => {
                const w = (note.duration / totalBeats) * (width - padding * 2);
                if (!note.rest) {
                    const y = ((maxNote - note.midi) / noteRange) * (height - 20) + 10;
                    notePositions.push({ x: cx + 4, y });
                }
                cx += w;
            });
            if (notePositions.length > 1) {
                ctx.strokeStyle = 'rgba(56, 189, 248, 0.25)';
                ctx.lineWidth = 1.5;
                ctx.beginPath();
                ctx.moveTo(notePositions[0].x, notePositions[0].y);
                notePositions.slice(1).forEach(p => ctx.lineTo(p.x, p.y));
                ctx.stroke();
            }
        }

        // â”€â”€â”€ CHORD PROGRESSION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        function generateProgression() {
            const key = document.getElementById('key').value;
            const mode = document.getElementById('mode').value;
            const voicingMode = document.getElementById('voicingMode').value;
            const fixedVoicing = document.getElementById('fixedVoicing').value;
            const variety = parseFloat(document.getElementById('variety').value);
            const length = parseInt(document.getElementById('length').value);
            const rate = parseInt(document.getElementById('rate').value);
            const complexity = parseFloat(document.getElementById('complexity').value);
            const useInversions = document.getElementById('inversions').checked;

            const baseProgression = commonProgressions[mode][Math.floor(Math.random() * commonProgressions[mode].length)];
            const rootMidi = noteToMidi(key);
            const voicingTypes = ['triad', 'seventh', 'ninth', 'eleventh'];
            const chordsToUse = baseProgression.slice(0, length);

            const tempChords = [];
            chordsToUse.forEach(chordName => {
                const voicings = chordLibrary[mode][chordName];
                let selectedVoicing;
                if (voicingMode === 'fixed') {
                    selectedVoicing = fixedVoicing;
                } else if (voicingMode === 'varied') {
                    const r = Math.random();
                    if (r < (1 - variety) * 0.5) selectedVoicing = 'triad';
                    else if (r < (1 - variety) * 0.7 + variety * 0.3) selectedVoicing = 'seventh';
                    else if (r < (1 - variety) * 0.85 + variety * 0.6) selectedVoicing = 'ninth';
                    else selectedVoicing = 'eleventh';
                } else {
                    selectedVoicing = voicingTypes[Math.floor(Math.random() * voicingTypes.length)];
                }
                const intervals = voicings[selectedVoicing];
                const midi = intervals.map(i => rootMidi + i);
                let duration = rate;
                if (Math.random() < complexity) duration = [2, 4, 8][Math.floor(Math.random() * 3)];
                tempChords.push({ name: chordName, voicing: selectedVoicing, rootMidi: midi, duration });
            });

            if (useInversions && tempChords.length > 1) {
                let bestSeq = null, bestDist = Infinity;
                for (let firstInv = 0; firstInv < tempChords[0].rootMidi.length; firstInv++) {
                    const first = [...tempChords[0].rootMidi];
                    for (let i = 0; i < firstInv; i++) first.push(first.shift() + 12);
                    const seq = [first];
                    let totalDist = 0;
                    for (let i = 1; i < tempChords.length; i++) {
                        const next = findBestInversion(tempChords[i].rootMidi, seq[i - 1]);
                        seq.push(next);
                        const voices = Math.min(seq[i - 1].length, next.length);
                        for (let v = 0; v < voices; v++) totalDist += Math.abs(next[v] - seq[i - 1][v]);
                    }
                    const last = seq[seq.length - 1];
                    const voices = Math.min(last.length, first.length);
                    for (let v = 0; v < voices; v++) totalDist += Math.abs(first[v] - last[v]);
                    if (totalDist < bestDist) { bestDist = totalDist; bestSeq = seq.map(s => [...s]); }
                }
                if (bestSeq) {
                    progression = tempChords.map((chord, idx) => {
                        const midi = bestSeq[idx];
                        const lowest = midi[0] % 12, root = chord.rootMidi[0] % 12;
                        let inversion = 'root';
                        if (lowest !== root) {
                            const invIdx = chord.rootMidi.findIndex(n => (n % 12) === lowest);
                            if (invIdx === 1) inversion = '1st';
                            else if (invIdx === 2) inversion = '2nd';
                            else if (invIdx === 3) inversion = '3rd';
                            else if (invIdx > 0) inversion = invIdx + 'th';
                        }
                        return { name: chord.name, notes: midi.map(midiToNote), voicing: chord.voicing, inversion, duration: chord.duration };
                    });
                }
            } else {
                progression = tempChords.map(chord => ({
                    name: chord.name, notes: chord.rootMidi.map(midiToNote),
                    voicing: chord.voicing, inversion: 'root', duration: chord.duration
                }));
            }

            displayProgression();
            drawTimeline();
            generateBassLine(); // auto-regenerate bass line when chords change
        }

        function displayProgression() {
            const list = document.getElementById('progressionList');
            const useInv = document.getElementById('inversions').checked;
            list.innerHTML = progression.map(c => `
                <div class="chord-item">
                    <div>
                        <span class="chord-name">${c.name}</span>
                        <span style="color: #d8b4fe; margin-left: 1rem;">${c.notes.join(' - ')}</span>
                        <span style="color: rgba(233,213,255,0.6); font-size: 0.875rem; margin-left: 0.75rem;">
                            (${c.voicing}${useInv ? ', ' + c.inversion + ' inv' : ''})
                        </span>
                    </div>
                    <div style="font-family: monospace; color: #d8b4fe;">${c.duration} beats</div>
                </div>
            `).join('');
            
            if (progression.length > 0 && useInv) {
                const first = progression[0].notes.map(noteNameToMidi);
                const last = progression[progression.length - 1].notes.map(noteNameToMidi);
                let totalDist = 0;
                const voices = Math.min(first.length, last.length);
                for (let i = 0; i < voices; i++) totalDist += Math.abs(first[i] - last[i]);
                const avgDist = (totalDist / voices).toFixed(1);
                const quality = document.getElementById('loopQuality');
                if (avgDist < 3) {
                    quality.innerHTML = `<strong>Loop Quality: Excellent âœ“</strong><br>Average distance: ${avgDist} semitones (very smooth loop)`;
                    quality.style.background = 'rgba(34, 197, 94, 0.2)';
                } else if (avgDist < 6) {
                    quality.innerHTML = `<strong>Loop Quality: Good</strong><br>Average distance: ${avgDist} semitones (smooth loop)`;
                    quality.style.background = 'rgba(234, 179, 8, 0.2)';
                } else {
                    quality.innerHTML = `<strong>Loop Quality: Fair</strong><br>Average distance: ${avgDist} semitones (moderate jump)`;
                    quality.style.background = 'rgba(239, 68, 68, 0.2)';
                }
                const details = [];
                for (let i = 0; i < voices; i++) details.push(`Voice ${i + 1}: ${Math.abs(first[i] - last[i])} semitones`);
                quality.innerHTML += `<br><span style="font-size: 0.875rem; color: rgba(233, 213, 255, 0.7);">${details.join(' â€¢ ')}</span>`;
            } else {
                document.getElementById('loopQuality').innerHTML = '';
            }
        }

        function drawTimeline() {
            if (progression.length === 0) return;
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            const container = document.getElementById('timeline');
            const width = container.clientWidth || 800;
            const padding = 10;

            // Collect all midi values â€” chords + bass
            let allMidi = [];
            progression.forEach(c => c.notes.forEach(n => allMidi.push(noteNameToMidi(n))));
            bassLine.forEach(n => { if (!n.rest) allMidi.push(n.midi); });
            const minNote = Math.min(...allMidi) - 1, maxNote = Math.max(...allMidi) + 1;
            const noteCount = maxNote - minNote + 1;

            // Height: clamp row height so total never exceeds ~380px or goes below readable
            const rowH = Math.min(28, Math.max(14, Math.floor(340 / noteCount)));
            const height = noteCount * rowH;

            canvas.width = width;
            canvas.height = height;
            container.style.height = height + 'px';
            ctx.clearRect(0, 0, width, height);

            const totalBeats = progression.reduce((sum, c) => sum + c.duration, 0);
            const toY = midi => ((maxNote - midi) / (maxNote - minNote)) * height;

            // â”€â”€ Divider between bass and chord register â”€â”€
            const bassMax = bassLine.filter(n => !n.rest).reduce((m, n) => Math.max(m, n.midi), 0);
            const chordMin = Math.min(...progression.flatMap(c => c.notes.map(noteNameToMidi)));
            if (bassMax > 0 && bassMax < chordMin) {
                const dividerY = (toY(bassMax) + toY(chordMin)) / 2;
                ctx.strokeStyle = 'rgba(255,255,255,0.07)';
                ctx.lineWidth = 1;
                ctx.setLineDash([6, 5]);
                ctx.beginPath();
                ctx.moveTo(0, dividerY);
                ctx.lineTo(width, dividerY);
                ctx.stroke();
                ctx.setLineDash([]);
            }

            // â”€â”€ Chord voice lines â”€â”€
            let time = 0;
            const positions = progression.map(c => {
                const x = padding + (time / totalBeats) * (width - padding * 2);
                const notes = c.notes.map(n => {
                    const midi = noteNameToMidi(n);
                    return { midi, y: toY(midi) };
                });
                time += c.duration;
                return { x, notes, chord: c };
            });

            ctx.lineWidth = 2.5;
            for (let i = 0; i < positions.length - 1; i++) {
                const curr = positions[i], next = positions[i + 1];
                const maxVoices = Math.max(curr.notes.length, next.notes.length);
                for (let v = 0; v < maxVoices; v++) {
                    if (v < curr.notes.length && v < next.notes.length) {
                        const grad = ctx.createLinearGradient(curr.x, curr.notes[v].y, next.x, next.notes[v].y);
                        grad.addColorStop(0, 'rgba(168, 85, 247, 0.7)');
                        grad.addColorStop(1, 'rgba(139, 92, 246, 0.7)');
                        ctx.strokeStyle = grad;
                        ctx.beginPath();
                        ctx.moveTo(curr.x, curr.notes[v].y);
                        ctx.lineTo(next.x, next.notes[v].y);
                        ctx.stroke();
                    }
                }
            }
            const dotR = Math.max(3, Math.min(5, rowH / 4));
            timelineHitTargets = [];
            positions.forEach((pos, chordIdx) => {
                const chord = pos.chord;
                pos.notes.forEach((note, voiceIdx) => {
                    ctx.fillStyle = 'rgba(168, 85, 247, 0.3)';
                    ctx.beginPath();
                    ctx.arc(pos.x, note.y, dotR + 3, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.fillStyle = '#8b5cf6';
                    ctx.beginPath();
                    ctx.arc(pos.x, note.y, dotR, 0, Math.PI * 2);
                    ctx.fill();
                    timelineHitTargets.push({
                        x: pos.x, y: note.y, r: dotR + 6,
                        isBass: false,
                        label: `${chord.name}  â€¢  ${midiToNote(note.midi)}\nVoice ${voiceIdx + 1}  â€¢  ${chord.voicing}, ${chord.inversion} inv\n${chord.duration} beats`
                    });
                });
            });

            // â”€â”€ Bass line notes â”€â”€
            if (bassLine.length > 0) {
                const bassTotalBeats = bassLine.reduce((s, n) => s + n.duration, 0);
                let bx = padding;
                const bassPoints = [];

                bassLine.forEach((note, bassIdx) => {
                    const bw = (note.duration / bassTotalBeats) * (width - padding * 2);
                    if (!note.rest) {
                        const by = toY(note.midi);
                        bassPoints.push({ x: bx + 4, y: by });

                        ctx.fillStyle = 'rgba(14, 165, 233, 0.12)';
                        ctx.beginPath();
                        ctx.arc(bx + 4, by, dotR + 6, 0, Math.PI * 2);
                        ctx.fill();

                        ctx.strokeStyle = 'rgba(56, 189, 248, 0.5)';
                        ctx.lineWidth = 1.5;
                        ctx.beginPath();
                        ctx.arc(bx + 4, by, dotR + 3, 0, Math.PI * 2);
                        ctx.stroke();

                        ctx.fillStyle = '#38bdf8';
                        ctx.beginPath();
                        ctx.arc(bx + 4, by, dotR, 0, Math.PI * 2);
                        ctx.fill();

                        if (rowH >= 16) {
                            ctx.fillStyle = 'rgba(125, 211, 252, 0.75)';
                            ctx.font = `${Math.max(8, rowH - 6)}px monospace`;
                            ctx.fillText(midiToNote(note.midi), bx + 14, by + 4);
                        }

                        timelineHitTargets.push({
                            x: bx + 4, y: by, r: dotR + 8,
                            isBass: true,
                            label: `Bass  â€¢  ${midiToNote(note.midi)}\n${note.type}  â€¢  ${note.duration} beat${note.duration !== 1 ? 's' : ''}`
                        });
                    }
                    bx += bw;
                });

                if (bassPoints.length > 1) {
                    ctx.strokeStyle = 'rgba(56, 189, 248, 0.3)';
                    ctx.lineWidth = 1.5;
                    ctx.setLineDash([4, 3]);
                    ctx.beginPath();
                    ctx.moveTo(bassPoints[0].x, bassPoints[0].y);
                    bassPoints.slice(1).forEach(p => ctx.lineTo(p.x, p.y));
                    ctx.stroke();
                    ctx.setLineDash([]);
                }
            }

            // â”€â”€ Labels & grid â”€â”€
            const timeline = document.getElementById('timeline');
            timeline.querySelectorAll('.note-labels, .grid-line').forEach(el => el.remove());

            const labelDiv = document.createElement('div');
            labelDiv.className = 'note-labels';
            for (let midi = maxNote; midi >= minNote; midi--) {
                const label = document.createElement('div');
                label.textContent = midiToNote(midi);
                const isBass = bassLine.some(n => !n.rest && n.midi === midi);
                const isChord = progression.some(c => c.notes.some(n => noteNameToMidi(n) === midi));
                label.style.color = isBass && !isChord ? '#7dd3fc' : '#d8b4fe';
                label.style.fontSize = Math.max(8, rowH - 6) + 'px';
                label.style.fontFamily = 'monospace';
                label.style.lineHeight = rowH + 'px';
                labelDiv.appendChild(label);
            }
            timeline.appendChild(labelDiv);

            for (let midi = maxNote; midi >= minNote; midi--) {
                const line = document.createElement('div');
                line.className = 'grid-line';
                line.style.top = toY(midi) + 'px';
                timeline.appendChild(line);
            }
        }

        function exportProgression() {
            const useInv = document.getElementById('inversions').checked;
            const key = document.getElementById('key').value;
            const mode = document.getElementById('mode').value;
            const bassStyle = document.getElementById('bassStyle').value;
            const bassOctave = document.getElementById('bassOctave').value;

            const chordText = `Key: ${key} ${mode}
Smart Inversions: ${useInv ? 'Enabled' : 'Disabled'}
Total Loop Length: ${progression.reduce((s, c) => s + c.duration, 0)} beats

Chord Progression:
${progression.map((c, i) => `${i + 1}. ${c.name} [${c.voicing}${useInv ? ', ' + c.inversion + ' inv' : ''}] - ${c.notes.join(', ')} - ${c.duration} beats`).join('\n')}`;

            const bassText = bassLine.length > 0 ? `

Bass Line (style: ${bassStyle}, octave: ${bassOctave}):
${bassLine.map((n, i) => n.rest ? `${i + 1}. REST - ${n.duration} beats` : `${i + 1}. ${midiToNote(n.midi)} [${n.type}] - ${n.duration} beats`).join('\n')}` : '';

            navigator.clipboard.writeText(chordText + bassText).then(() => {
                alert('Copied to clipboard!');
            }).catch(() => {
                alert('Could not copy to clipboard');
            });
        }

        updateVoicingControls();
        generateProgression();

        // â”€â”€ MIDI Export â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        function exportMidi() {
            if (progression.length === 0) return;

            const bpm = parseInt(document.getElementById('bpm').value);
            const PPQ = 480; // pulses per quarter note
            const uspb = Math.round(60_000_000 / bpm); // microseconds per beat

            // â”€â”€ Helpers to write MIDI bytes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

            function varLen(n) {
                // Encode n as MIDI variable-length quantity
                const bytes = [];
                bytes.push(n & 0x7F);
                n >>= 7;
                while (n > 0) { bytes.unshift((n & 0x7F) | 0x80); n >>= 7; }
                return bytes;
            }

            function word16(n) { return [(n >> 8) & 0xFF, n & 0xFF]; }
            function word32(n) { return [(n >> 24) & 0xFF, (n >> 16) & 0xFF, (n >> 8) & 0xFF, n & 0xFF]; }

            function makeTrack(events) {
                // events: [{ tick, type, data[] }]  sorted by tick
                events.sort((a, b) => a.tick - b.tick);

                const body = [];
                let cursor = 0;
                events.forEach(ev => {
                    const delta = ev.tick - cursor;
                    cursor = ev.tick;
                    body.push(...varLen(delta), ...ev.data);
                });
                // End of track
                body.push(0x00, 0xFF, 0x2F, 0x00);

                return [
                    0x4D, 0x54, 0x72, 0x6B,   // "MTrk"
                    ...word32(body.length),
                    ...body
                ];
            }

            // â”€â”€ Track 0: Tempo map â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

            const tempoTrack = makeTrack([
                { tick: 0, data: [0xFF, 0x51, 0x03, ...[(uspb >> 16) & 0xFF, (uspb >> 8) & 0xFF, uspb & 0xFF]] },
                { tick: 0, data: [0xFF, 0x03, ...stringBytes('Ambient Composer')] },
            ]);

            function stringBytes(s) {
                const b = [];
                for (let i = 0; i < s.length; i++) b.push(s.charCodeAt(i));
                return [...varLen(b.length), ...b];
            }

            // â”€â”€ Track 1: Chords (channel 0) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

            const chordEvents = [];
            const chordVelocity = 80;
            let tick = 0;

            progression.forEach(chord => {
                const durationTicks = chord.duration * PPQ;
                const midiNotes = chord.notes.map(noteNameToMidi);

                midiNotes.forEach(midi => {
                    chordEvents.push({ tick, data: [0x90, midi, chordVelocity] });           // note on  ch1
                    chordEvents.push({ tick: tick + durationTicks - 1, data: [0x80, midi, 0] }); // note off ch1
                });
                tick += durationTicks;
            });

            // Track name
            chordEvents.push({ tick: 0, data: [0xFF, 0x03, ...stringBytes('Chords')] });

            const chordTrack = makeTrack(chordEvents);

            // â”€â”€ Track 2: Bass (channel 1) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

            const bassEvents = [];
            const bassVelocity = 95;
            tick = 0;

            bassLine.forEach(note => {
                const durationTicks = note.duration * PPQ;
                if (!note.rest) {
                    bassEvents.push({ tick, data: [0x91, note.midi, bassVelocity] });
                    bassEvents.push({ tick: tick + durationTicks - 1, data: [0x81, note.midi, 0] });
                }
                tick += durationTicks;
            });

            bassEvents.push({ tick: 0, data: [0xFF, 0x03, ...stringBytes('Bass')] });
            // Channel 1 program change â†’ Electric Bass (finger) = patch 33
            bassEvents.push({ tick: 0, data: [0xC1, 33] });

            const bassTrack = makeTrack(bassEvents);

            // â”€â”€ Assemble MIDI file â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

            const numTracks = 3;
            const header = [
                0x4D, 0x54, 0x68, 0x64,  // "MThd"
                0x00, 0x00, 0x00, 0x06,  // chunk length = 6
                0x00, 0x01,              // format 1 (multi-track)
                ...word16(numTracks),
                ...word16(PPQ),
            ];

            const midi = new Uint8Array([...header, ...tempoTrack, ...chordTrack, ...bassTrack]);

            // â”€â”€ Trigger download â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

            const key  = document.getElementById('key').value;
            const mode = document.getElementById('mode').value;
            const blob = new Blob([midi], { type: 'audio/midi' });
            const url  = URL.createObjectURL(blob);
            const a    = document.createElement('a');
            a.href     = url;
            a.download = `ambient-${key}-${mode}-${bpm}bpm.mid`;
            a.click();
            URL.revokeObjectURL(url);
        }
        (function() {
            const tooltip = document.getElementById('timeline-tooltip');
            const canvas = document.getElementById('canvas');

            canvas.addEventListener('mousemove', e => {
                const rect = canvas.getBoundingClientRect();
                // Scale mouse coords from CSS pixels to canvas pixels
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                const mx = (e.clientX - rect.left) * scaleX;
                const my = (e.clientY - rect.top) * scaleY;

                let hit = null;
                let best = Infinity;
                timelineHitTargets.forEach(t => {
                    const dist = Math.sqrt((mx - t.x) ** 2 + (my - t.y) ** 2);
                    if (dist < t.r && dist < best) { best = dist; hit = t; }
                });

                if (hit) {
                    const lines = hit.label.split('\n');
                    tooltip.innerHTML = lines.map((l, i) => {
                        const color = i === 0
                            ? (hit.isBass ? '#7dd3fc' : '#d8b4fe')
                            : 'rgba(233,213,255,0.65)';
                        return `<span style="color:${color}">${l}</span>`;
                    }).join('<br>');
                    tooltip.style.borderColor = hit.isBass
                        ? 'rgba(56,189,248,0.6)'
                        : 'rgba(168,85,247,0.6)';

                    // Position tooltip â€” keep it inside viewport
                    const tw = 180, th = 70;
                    let tx = e.clientX + 14;
                    let ty = e.clientY - 10;
                    if (tx + tw > window.innerWidth - 8) tx = e.clientX - tw - 14;
                    if (ty + th > window.innerHeight - 8) ty = e.clientY - th - 10;
                    tooltip.style.left = tx + 'px';
                    tooltip.style.top = ty + 'px';
                    tooltip.classList.add('visible');
                    canvas.style.cursor = 'pointer';
                } else {
                    tooltip.classList.remove('visible');
                    canvas.style.cursor = 'crosshair';
                }
            });

            canvas.addEventListener('mouseleave', () => {
                tooltip.classList.remove('visible');
            });
        })();

        // Redraw on window resize
        let resizeTimer;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(() => {
                drawTimeline();
                drawBassTimeline();
            }, 100);
        });
    </script>


</body></html>